<script src="/assets/js/moment.js"></script>

<script type="text/javascript" src="/assets/js/post_parameters.js"></script>

<style type="text/css">
    body {
        -moz-user-select:none;
    }

    #stats {
        width:98%;
        border:1px solid #eee;
        margin:10px;
        margin-top: 0px;
        background:white;
    }
    #stats td, #stats th {
        text-align:center;
    }
    .odd {
        background-color: #eeeef7;
    }
    .even {
        background-color: #fff;
    }

    #table_div {
        overflow:auto;
        height: 320px;
        background-color: white;
        border: solid 1px #eee;
        border-width: 1px;
        overflow: hidden;
    }

</style>
<div id="tab" style="background-color: #fff; border-top: 1px #fff solid; margin-top: 0px;">
    <h2 style="text-align: center; color: #6281a7; margin-top: -2px; margin-bottom: 0px;">Current Visit Statistics</h2>
    <table id="stats" style="height: 315px; margin-bottom: 8px;" cellpadding="5">
        <tr style="color: #fff; background-color: #6281a7;">
            <th style="text-align:left;">Task Type </th>
            <th id="username">Me</th>
            <th>Today</th>
            <th>This Year</th>
        </tr>
        <tr class="even">
            <td style="text-align:left;">Registration</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
        <tr class="odd">
            <td style="text-align:left;">Observations</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
        <tr class="even">
            <td style="text-align:left;">Vitals</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
        <tr class="odd">
            <td style="text-align:left;">Diagnosis</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
        <tr class="even">
            <td style="text-align:left;">Update Outcome</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
        <tr class="odd">
            <td style="text-align:left;">Referrals - Out</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
    </table>
</div>

<script type="text/javascript">
    var stats = {all: true, encounter_types: [5, 61, 6, 41, 40, 63]};
    var apiProtocol = sessionStorage.apiProtocol;
    var apiURL = sessionStorage.apiURL;
    var apiPort = sessionStorage.apiPort;
    var programID = sessionStorage.programID;

    var encounter_types = {}
    encounter_types[5] = "Registration";
    encounter_types[61] = "Observations";
    encounter_types[6] = "Vitals";
    encounter_types[41] = "Diagnosis";
    encounter_types[40] = "Update Outcome";
    encounter_types[63] = "Referrals Out";
    var end_date = moment().subtract(1, "days").format("YYYY-MM-DD");
    var start_date = moment().subtract(5, "days").format("YYYY-MM-DD");

    function dashboardStats(stats) {

        console.log('total ' + stats);

        var top_colunm = stats['top'];
        document.getElementById('reg-today').innerHTML = top_colunm.registered_today;
        document.getElementById('returning-today').innerHTML = top_colunm.returning_today;
        document.getElementById('referred-today').innerHTML = top_colunm.referred_today;
        var total = parseInt(top_colunm.referred_today);
        total += parseInt(top_colunm.returning_today);
        total += parseInt(top_colunm.registered_today);
        // document.getElementById('reg-total').innerHTML = total;

        console.log('total ' + total);
    }

    function fetchDashboardStats() {
        var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1";
        url += "/dashboard_stats?date=" + sessionStorage.sessionDate;
        url+= "&program_id=" + sessionStorage.programID;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
                var obj = JSON.parse(this.responseText);
                dashboardStats(obj);
            }
        };
        xhttp.open("GET", url, true);
        xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
        xhttp.setRequestHeader('Content-type', "application/json");
        xhttp.send();
    }

    setTimeout("fetchDashboardStats()", 200);

    var usernameField = document.getElementById("username");
    if (usernameField) {
        usernameField.innerHTML = sessionStorage.username.toUpperCase();
    }
</script>